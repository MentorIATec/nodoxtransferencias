<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bienvenida de Transferencias - Tu historia en Monterrey empieza hoy 🎓</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* Colores del Tec */
            --tec-blue: #003b5c;
            --tec-blue-light: #005b8a;
            --tec-blue-bright: #0062cc;
            
            /* Colores de comunidades */
            --talenta: #EC008C;
            --revo: #C4829A;
            --kresko: #0DCCCC;
            --pasio: #CC0202;
            --energio: #FD8204;
            --krei: #79858B;
            --reflekto: #FFDE17;
            --forta: #870074;
            --spirita: #5B0F8B;
            --ekvilibro: #6FD34A;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--tec-blue) 0%, var(--tec-blue-light) 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            max-width: 650px;
            width: 100%;
            overflow: hidden;
            opacity: 0;
            animation: fadeIn 0.5s ease forwards;
        }
        
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        .header {
            background: linear-gradient(135deg, var(--tec-blue-bright) 0%, #004a99 100%);
            color: white;
            padding: 50px 30px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 3s ease infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1); opacity: 0.8; }
        }
        
        .emoji-header {
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 2s ease infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        
        .subtitle {
            font-size: 20px;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            margin-top: 10px;
        }
        
        .content {
            padding: 40px 30px;
        }
        
        .search-section {
            margin-bottom: 30px;
        }
        
        .welcome-text {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
            font-size: 18px;
            line-height: 1.6;
        }
        
        label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        input {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: var(--tec-blue-bright);
            box-shadow: 0 0 0 4px rgba(0, 98, 204, 0.1);
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn:active::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary {
            background: var(--tec-blue-bright);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #004a99;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 98, 204, 0.3);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
            width: 100%;
            justify-content: center;
            margin: 10px 0;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-whatsapp {
            background: #25d366;
            color: white;
            width: 100%;
            justify-content: center;
            margin: 10px 0;
        }
        
        .btn-whatsapp:hover:not(:disabled) {
            background: #1da851;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 211, 102, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
            width: 100%;
            justify-content: center;
            margin: 10px 0;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        
        .error {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .event-info {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
        }
        
        .event-info h3 {
            color: var(--tec-blue);
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .info-box {
            background: white;
            padding: 25px 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .info-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
        }
        
        .info-box-colored {
            color: white;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .info-box-colored::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: rotate 10s linear infinite;
        }
        
        @keyframes rotate {
            to { transform: rotate(360deg); }
        }
        
        .info-box h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        
        .info-box p {
            font-size: 20px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }
        
        .mentor-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        /* Colores dinámicos de comunidades */
        .comunidad-talenta { background: linear-gradient(135deg, var(--talenta), #d10078) !important; }
        .comunidad-revo { background: linear-gradient(135deg, var(--revo), #b07189) !important; }
        .comunidad-kresko { background: linear-gradient(135deg, var(--kresko), #0bb8b8) !important; }
        .comunidad-pasio { background: linear-gradient(135deg, var(--pasio), #b80202) !important; }
        .comunidad-energio { background: linear-gradient(135deg, var(--energio), #e37404) !important; }
        .comunidad-krei { background: linear-gradient(135deg, var(--krei), #6a757a) !important; }
        .comunidad-reflekto { 
            background: linear-gradient(135deg, var(--reflekto), #e6c815) !important; 
            color: #333 !important;
        }
        .comunidad-forta { background: linear-gradient(135deg, var(--forta), #750063) !important; }
        .comunidad-spirita { background: linear-gradient(135deg, var(--spirita), #4f0c7a) !important; }
        .comunidad-ekvilibro { background: linear-gradient(135deg, var(--ekvilibro), #5fc33d) !important; }
        
        .detail-list {
            list-style: none;
            padding: 0;
        }
        
        .detail-list li {
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
        }
        
        .detail-list li:last-child {
            border-bottom: none;
        }
        
        .icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .highlight-list {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .highlight-list h4 {
            color: var(--tec-blue);
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .highlight-list ul {
            list-style: none;
            padding: 0;
        }
        
        .highlight-list li {
            padding: 8px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .service-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .service-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.12);
        }
        
        .service-item .emoji {
            font-size: 30px;
            margin-bottom: 8px;
        }
        
        .service-item p {
            font-size: 14px;
            color: #555;
            margin: 0;
        }
        
        .tip-box {
            background: #fff3cd;
            border: 2px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tip-box .emoji {
            font-size: 24px;
        }
        
        .success-message {
            text-align: center;
            padding: 40px;
            animation: zoomIn 0.5s ease;
        }
        
        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .success-icon {
            width: 80px;
            height: 80px;
            background: #28a745;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 40px;
            color: white;
            animation: checkmark 0.8s ease;
        }
        
        @keyframes checkmark {
            0% { transform: scale(0) rotate(-45deg); }
            50% { transform: scale(1.2) rotate(-45deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        .attendance-options {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .attendance-options h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        @media (max-width: 600px) {
            .options-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--tec-blue-bright);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--tec-blue-bright);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @media (max-width: 600px) {
            .header {
                padding: 40px 20px 30px;
            }
            
            h1 {
                font-size: 28px;
            }
            
            .subtitle {
                font-size: 18px;
            }
            
            .content {
                padding: 30px 20px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
        }
            #mentorName,
            .mentor-comunidad,
            #communityName {
                background: none !important;
            }

    </style>
</head>
<body>
        <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Cargando datos...</p>
        </div>
    </div>
    
<div class="container">  
    <div class="header">
        <div class="emoji-header">🎉🎓✨</div>
        <h1>Bienvenida de Transferencias</h1>
        <p class="subtitle">¡Tu historia en Monterrey empieza hoy!</p>
    </div>
        
    <div class="content">
        <!-- Sección de búsqueda -->
        <div id="searchSection" class="search-section">
            <p class="welcome-text">
                ¡Hola! 👋 Esperamos que estés teniendo un gran día.<br>
                Queremos invitarte a la <strong>Bienvenida de Transferencias</strong> en el Campus Monterrey.
            </p>
            <label for="matricula">Para continuar, ingresa tu matrícula:</label>
            <div class="input-group">
                <input 
                    type="text" 
                    id="matricula" 
                    placeholder="Ej: A01234567"
                    maxlength="9"
                    autocomplete="off"
                >
                <button class="btn btn-primary" onclick="buscarEstudiante()">
                    <span>🔍</span> Buscar
                </button>
            </div>
            <p id="errorMessage" class="error hidden"></p>
        </div>
        
        <!-- Sección de información del estudiante -->
        <div id="studentInfo" class="hidden">
            <div class="info-card">
                <h3 id="welcomeMessage" style="color: var(--tec-blue); font-size: 24px;"></h3>
                <p style="color: #666; margin-bottom: 20px; font-size: 18px;">
                    ¡Te esperamos con mucha emoción! 🎊
                </p>
            </div>
            
            <div class="info-grid">
                <div id="mentorBox" class="info-box info-box-colored">
                    <div class="mentor-icon">👥</div>
                    <h4>Tu Mentor/a</h4>
                    <p id="mentorName"></p>
                </div>
                <div id="communityBox" class="info-box info-box-colored">
                    <div class="mentor-icon">🏠</div>
                    <h4>Tu Comunidad</h4>
                    <p id="communityName"></p>
                </div>
            </div>
            
            <div class="event-info">
                <h3>🌟 Detalles del Evento</h3>
                <ul class="detail-list">
                    <li>
                        <span class="icon">📅</span>
                        <strong>Fecha:</strong> &nbsp;Viernes 8 de agosto
                    </li>
                    <li>
                        <span class="icon">⏰</span>
                        <strong>Horario:</strong> &nbsp;8:30 a.m. - 12:00 p.m.
                    </li>
                    <li>
                        <span class="icon">📍</span>
                        <strong>Lugar:</strong> &nbsp;Pabellón "La Carreta"
                        <a href="mapa-evento.html" target="_blank" style="
                            display: inline-block;
                            margin-top: 10px;
                            background: #0062cc;
                            color: #fff;
                            padding: 7px 18px;
                            border-radius: 22px;
                            font-weight: bold;
                            font-size: 15px;
                            text-decoration: none;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.07);
                            transition: background 0.2s;">
                            🗺️ Ver cómo llegar
                        </a>
                    </li>
                </ul>
                
                <div class="highlight-list">
                    <h4>🌟 En este evento podrás:</h4>
                    <ul>
                        <li><span>✅</span> Conocer a tu mentor/a y comunidad</li>
                        <li><span>✅</span> Disfrutar de un rico desayuno 🥐☕</li>
                        <li><span>✅</span> Hacer un tour por el campus 🏫</li>
                        <li><span>✅</span> Visitar estands de servicios y actividades</li>
                        <li><span>✅</span> ¡Habrá algunos regalos! 🎁</li>
                    </ul>
                </div>
                
                <div class="services-grid">
                    <div class="service-item">
                        <div class="emoji">🎭</div>
                        <p><strong>Arte y Cultura</strong><br>Cartelera cultural</p>
                    </div>
                    <div class="service-item">
                        <div class="emoji">🆔</div>
                        <p><strong>Tec Services</strong><br>Actualiza tu ID</p>
                    </div>
                    <div class="service-item">
                        <div class="emoji">💼</div>
                        <p><strong>CVDP</strong><br>Desarrollo profesional</p>
                    </div>
                </div>
            </div>
            
            <div class="tip-box">
                <span class="emoji">💡</span>
                <p><strong>Tip:</strong> ¡No olvides llevar tu termo para mantenerte hidratado! 💙♻️</p>
            </div>
            
            <div class="attendance-options" id="attendanceOptions">
                <h4>Selecciona una opción:</h4>
                <div class="options-grid">
                    <button class="btn btn-success" onclick="confirmarAsistencia(true, event)">
                        ✓ ¡Sí asistiré!
                    </button>
                    <button class="btn btn-secondary" onclick="confirmarAsistencia(false, event)">
                        😔 No podré asistir
                    </button>
                </div>
            </div>
            <div id="mensajeYaRegistrado" style="display:none; margin:18px 0; color:#0062cc; font-weight:bold; text-align:center;">
                ✅ Ya registraste tu respuesta. No es necesario hacerlo de nuevo.
            </div>
            <button class="btn btn-whatsapp" onclick="contactarMentor()">
                💬 Contactar a mi mentor/a por WhatsApp
            </button>
        </div>
        
        <!-- Mensaje de confirmación - Asistencia -->
        <div id="confirmationYes" class="success-message hidden">
            <div class="success-icon">✓</div>
            <h2 style="color: #28a745; margin-bottom: 15px;">¡Excelente! Te esperamos 🎉</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 18px;">
                Hemos confirmado tu asistencia al evento.<br>
                No olvides contactar a tu mentor/a <span id="mentorConfirm"></span> por WhatsApp.
            </p>
            <button class="btn btn-whatsapp" onclick="contactarMentor()">
                💬 Enviar mensaje a mi mentor/a
            </button>
            <br>
            <button class="btn btn-secondary" onclick="mostrarInformacionEvento()">
                🔙 Ver detalles del evento y mi mentor/a
            </button>
        </div>
        
        <!-- Mensaje de confirmación - No asistencia -->
        <div id="confirmationNo" class="success-message hidden">
            <div class="success-icon" style="background: #6c757d;">😊</div>
            <h2 style="color: #6c757d; margin-bottom: 15px;">¡No te preocupes!</h2>
            <p style="color: #666; margin-bottom: 20px; font-size: 18px;">
                Aunque no puedas asistir al evento, tu mentor/a <span id="mentorNoConfirm"></span> está aquí para apoyarte.<br>
                Te recomendamos contactarlo/a para conocerse y resolver cualquier duda sobre tu llegada al campus.
            </p>
            <button class="btn btn-whatsapp" onclick="contactarMentorNoAsistencia()">
                💬 Contactar a mi mentor/a por WhatsApp
            </button>
            <br>
            <button class="btn btn-secondary" onclick="mostrarInformacionEvento()">
                🔙 Ver detalles del evento y mi mentor/a
            </button>
        </div>
    </div>
</div>
    
<script>
let estudiantesData = [];
let estudianteActual = null;

// Configuración Google Forms
const CONFIG = {
    GOOGLE_FORM_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSftfAfazFqnVWx5oo7XS-SIVv-_CoV0JQcU-npq39kitozEXQ/formResponse',
    FORM_FIELDS: {
        matricula: 'entry.1607137015',
        nombre: 'entry.1566331032',
        mentor: 'entry.710554786',
        comunidad: 'entry.1007914499',
        asistira: 'entry.52874123',
        timestamp: 'entry.829961349',
        correo: 'entry.1235512351',
    }
};

// Carga de datos
document.addEventListener('DOMContentLoaded', async () => {
    await cargarDatosEstudiantes();
});

// Helper para buscar el campo correcto
function getField(est, ...candidatos) {
    for (let c of candidatos) {
        if (est[c]) return est[c];
    }
    for (let key of Object.keys(est)) {
        if (candidatos.some(c => key.toLowerCase().includes(c.toLowerCase()))) {
            return est[key];
        }
    }
    return "";
}
async function cargarDatosEstudiantes() {
    try {
        const response = await fetch('/estudiantes.json');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();

        estudiantesData = data.map(estudiante => ({
            matricula: (estudiante.matricula || estudiante["matrícula"] || estudiante.Matricula)?.trim().toUpperCase(),
            nameEstudiante: estudiante.nameEstudiante?.trim(),
            fullnameEstudiante: estudiante.fullnameEstudiante?.trim(),
            mentorFullname: estudiante.mentorFullname?.trim(),
            mentorNickname: estudiante.mentorNickname?.trim(),
            whatsappMentor: estudiante.whatsappMentor?.trim(),
            comunidad: estudiante.comunidad?.trim(),
            campusOrigen: estudiante.campusOrigen?.trim(),
        })).filter(e => e.matricula);

        console.log('MATRÍCULAS CARGADAS:', estudiantesData.map(e => e.matricula));
    } catch (error) {
        console.error('❌ Error cargando datos:', error);
        estudiantesData = [];
    }
    document.getElementById('loadingOverlay').style.display = 'none';
}

// Búsqueda de estudiante
function buscarEstudiante() {
    const matricula = document.getElementById('matricula').value.trim().toUpperCase();
    const errorElement = document.getElementById('errorMessage');
    if (!matricula) {
        mostrarError('⚠️ Por favor ingresa tu matrícula');
        return;
    }
    const estudiante = estudiantesData.find(e =>
        e.matricula && e.matricula === matricula
    );
    if (estudiante) {
        estudianteActual = estudiante;
        mostrarInformacionEstudiante(estudiante);
        errorElement.classList.add('hidden');
    } else {
        mostrarError('⚠️ Matrícula no encontrada. Por favor verifica e intenta de nuevo.');
    }
}

function mostrarError(mensaje) {
    const errorElement = document.getElementById('errorMessage');
    errorElement.textContent = mensaje;
    errorElement.classList.remove('hidden');
}

// Muestra SIEMPRE los datos, solo oculta las opciones si ya registró
function mostrarInformacionEstudiante(estudiante) {
    const searchSection = document.getElementById('searchSection');
    searchSection.style.opacity = '0';
    setTimeout(() => {
        searchSection.classList.add('hidden');
        document.getElementById('welcomeMessage').textContent = estudiante.nameEstudiante
            ? `¡Hola, ${estudiante.nameEstudiante.trim()}! 👋`
            : `¡Hola! 👋`;
        
        const comunidadKey = estudiante.comunidad.trim().toLowerCase();
        const mentorNameElem = document.getElementById('mentorName');
        mentorNameElem.textContent = estudiante.mentorFullname;
        mentorNameElem.className = `mentor-comunidad comunidad-${comunidadKey}`;
        document.getElementById('communityName').textContent = estudiante.comunidad;
        document.getElementById('mentorConfirm').textContent = estudiante.mentorFullname;
        document.getElementById('mentorNoConfirm').textContent = estudiante.mentorFullname;
        const comunidadClass = `comunidad-${estudiante.comunidad.toLowerCase()}`;
        document.getElementById('communityBox').className = 'info-box info-box-colored comunidad-' + comunidadKey;
        document.getElementById('mentorBox').className = 'info-box info-box-colored comunidad-' + comunidadKey;
        document.getElementById('studentInfo').classList.remove('hidden');
        document.getElementById('studentInfo').style.opacity = 1;

        // Prevención de duplicados
        const yaRegistrado = localStorage.getItem('registroTransferido_' + estudiante.matricula) === '1';
        if (yaRegistrado) {
            document.getElementById('attendanceOptions').style.display = 'none';
            document.getElementById('mensajeYaRegistrado').style.display = 'block';
        } else {
            document.getElementById('attendanceOptions').style.display = '';
            document.getElementById('mensajeYaRegistrado').style.display = 'none';
        }
    }, 300);
}

async function confirmarAsistencia(asistira, event) {
    if (!estudianteActual) return;
    const boton = event.target;
    const textoOriginal = boton.innerHTML;
    const botones = document.querySelectorAll('.attendance-options .btn');
    botones.forEach(btn => btn.disabled = true);
    boton.innerHTML = '<span class="loading"></span> Procesando...';
    try {
        await enviarAGoogleForms(asistira);
        await new Promise(resolve => setTimeout(resolve, 1500));
        document.getElementById('studentInfo').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('studentInfo').classList.add('hidden');
            if (asistira) {
                document.getElementById('confirmationYes').classList.remove('hidden');
            } else {
                document.getElementById('confirmationNo').classList.remove('hidden');
            }
            // Guarda matrícula como registrada en localStorage
            localStorage.setItem('registroTransferido_' + estudianteActual.matricula, '1');
        }, 300);
    } catch (error) {
        botones.forEach(btn => btn.disabled = false);
        boton.innerHTML = textoOriginal;
        mostrarError('❌ Error al procesar la solicitud. Por favor intenta de nuevo.');
    }
}

async function enviarAGoogleForms(asistira) {
    if (!CONFIG.GOOGLE_FORM_URL || !estudianteActual) return;
    const formData = new FormData();
    formData.append(CONFIG.FORM_FIELDS.matricula, estudianteActual.matricula);
    formData.append(CONFIG.FORM_FIELDS.nombre, estudianteActual.fullnameEstudiante);
    formData.append(CONFIG.FORM_FIELDS.mentor, estudianteActual.mentorFullname);
    formData.append(CONFIG.FORM_FIELDS.comunidad, estudianteActual.comunidad);
    formData.append(CONFIG.FORM_FIELDS.asistira, asistira ? 'Sí' : 'No');
    const fechaHora = new Date().toLocaleString('es-MX', { 
        timeZone: 'America/Mexico_City',
        dateStyle: 'short',
        timeStyle: 'medium'
    });
    formData.append(CONFIG.FORM_FIELDS.timestamp, fechaHora);
    
    const correoGenerado = estudianteActual.matricula.toLowerCase() + '@itesm.mx';
    formData.append(CONFIG.FORM_FIELDS.correo, correoGenerado);

    try {
        await fetch(CONFIG.GOOGLE_FORM_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: formData
        });
    } catch (error) {
        throw error;
    }
}

function contactarMentor() {
    if (!estudianteActual) return;
    const mensaje = `¡Hola ${estudianteActual.mentorNickname}! 👋 Soy ${estudianteActual.fullnameEstudiante} y vengo de ${estudianteActual.campusOrigen}. Ya confirmé mi asistencia al evento de transferencias. ¡Nos vemos pronto! 🎓`;
    const numeroLimpio = estudianteActual.whatsappMentor.replace(/\D/g, '');
    const url = `https://wa.me/${numeroLimpio}?text=${encodeURIComponent(mensaje)}`;
    window.open(url, '_blank');
}

function contactarMentorNoAsistencia() {
    if (!estudianteActual) return;
    const mensaje = `¡Hola ${estudianteActual.mentorNickname}! 👋 Soy ${estudianteActual.fullnameEstudiante} y vengo de ${estudianteActual.campusOrigen}. Lamentablemente no podré asistir al evento de transferencias, pero me gustaría conocerte y platicar sobre mi llegada al campus. ¿Podríamos agendar una cita? 😊`;
    const numeroLimpio = estudianteActual.whatsappMentor.replace(/\D/g, '');
    const url = `https://wa.me/${numeroLimpio}?text=${encodeURIComponent(mensaje)}`;
    window.open(url, '_blank');
}

document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('matricula');
    if (input) {
        input.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                buscarEstudiante();
            }
        });
    }
});

// Muestra siempre los datos, solo oculta asistencia si ya registró
function mostrarInformacionEvento() {
    document.getElementById('confirmationYes').classList.add('hidden');
    document.getElementById('confirmationNo').classList.add('hidden');
    document.getElementById('studentInfo').classList.remove('hidden');
    document.getElementById('studentInfo').style.opacity = 1;
    document.getElementById('studentInfo').scrollIntoView({ behavior: "smooth" });
    if (estudianteActual) {
        const yaRegistrado = localStorage.getItem('registroTransferido_' + estudianteActual.matricula) === '1';
        if (yaRegistrado) {
            document.getElementById('attendanceOptions').style.display = 'none';
            document.getElementById('mensajeYaRegistrado').style.display = 'block';
        } else {
            document.getElementById('attendanceOptions').style.display = '';
            document.getElementById('mensajeYaRegistrado').style.display = 'none';
        }
    }
}
</script>
</body>
</html>
